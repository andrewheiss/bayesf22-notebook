{
  "hash": "9ddbdef3decefd88ea37bee75ec0ba7a",
  "result": {
    "markdown": "---\ntitle: \"Video #7 code\"\nsubtitle: \"Overfitting\"\ndate: \"October 5, 2022\"\n---\n\n\n<div class=\"ratio ratio-16x9\">\n<iframe src=\"https://www.youtube.com/embed/odGAAJDlgp8\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n</div>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(loo)\nlibrary(tidybayes)\n\n# Plot stuff\nclrs <- MetBrewer::met.brewer(\"Lakota\", 6)\ntheme_set(theme_bw())\n\n# Seed stuff\nset.seed(1234)\nBAYES_SEED <- 1234\n\ndata(WaffleDivorce, package = \"rethinking\")\n\nWaffleDivorce <- WaffleDivorce %>% \n  mutate(across(c(Marriage, Divorce, MedianAgeMarriage), ~scale(.), .names = \"{col}_scaled\")) %>% \n  mutate(across(c(Marriage, Divorce, MedianAgeMarriage), ~as.numeric(scale(.)), .names = \"{col}_z\"))\n```\n:::\n\n\n\n# Finding outliers with PSIS and WAIC\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(WaffleDivorce, aes(x = MedianAgeMarriage_z, y = Divorce_z)) +\n  geom_point(aes(color = Loc %in% c(\"ME\", \"ID\")), size = 2) +\n  geom_text(data = filter(WaffleDivorce, Loc %in% c(\"ME\", \"ID\")), \n            aes(label = Location), hjust = -0.25) +\n  scale_color_manual(values = c(\"grey40\", clrs[4]), guide = \"none\") +\n  labs(x = \"Age at marriage (standardized)\", y = \"Divorce rate (standardized)\")\n```\n\n::: {.cell-output-display}\n![](07-video_files/figure-html/unnamed-chunk-1-1.png){width=100%}\n:::\n:::\n\nRun a model:\n\n\n::: {.cell hash='07-video_cache/html/age-marriage-normal_6cfcc794d462570473d9a8a4341ece5e'}\n\n```{.r .cell-code}\npriors <- c(prior(normal(0, 0.2), class = Intercept),\n            prior(normal(0, 0.5), class = b, coef = \"Marriage_z\"),\n            prior(normal(0, 0.5), class = b, coef = \"MedianAgeMarriage_z\"),\n            prior(exponential(1), class = sigma))\n\nmarriage_divorce_normal <- brm(\n  bf(Divorce_z ~ Marriage_z + MedianAgeMarriage_z),\n  data = WaffleDivorce,\n  family = gaussian(),\n  prior = priors,\n  chains = 4, cores = 4, seed = BAYES_SEED, \n  backend = \"cmdstanr\", refresh = 0\n)\n## Start sampling\n```\n:::\n\n\nCheck the LOO stats. One value is fairly influential with k > 0.5, but the others are okay:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloo(marriage_divorce_normal)\n## \n## Computed from 4000 by 50 log-likelihood matrix\n## \n##          Estimate   SE\n## elpd_loo    -63.8  6.4\n## p_loo         4.8  1.9\n## looic       127.7 12.8\n## ------\n## Monte Carlo SE of elpd_loo is 0.1.\n## \n## Pareto k diagnostic values:\n##                          Count Pct.    Min. n_eff\n## (-Inf, 0.5]   (good)     49    98.0%   688       \n##  (0.5, 0.7]   (ok)        1     2.0%   176       \n##    (0.7, 1]   (bad)       0     0.0%   <NA>      \n##    (1, Inf)   (very bad)  0     0.0%   <NA>      \n## \n## All Pareto k estimates are ok (k < 0.7).\n## See help('pareto-k-diagnostic') for details.\n```\n:::\n\n\nWhich observation has the high PSIS k value?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloo(marriage_divorce_normal) |> \n  pareto_k_ids()\n## [1] 13\n```\n:::\n\n\nRow 13! Which is…\n\n\n::: {.cell}\n\n```{.r .cell-code}\nWaffleDivorce |> \n  slice(13) |> \n  select(Location)\n##   Location\n## 1    Idaho\n```\n:::\n\n\nIdaho.\n\nHow big is the actual k value?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloo(marriage_divorce_normal) |> \n  pareto_k_values() |> \n  pluck(13)\n## [1] 0.6065822\n```\n:::\n\n\nWe can embed these diagnostics into the brms object with `add_criterion()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmarriage_divorce_normal <- add_criterion(marriage_divorce_normal, criterion = \"loo\")\nmarriage_divorce_normal <- add_criterion(marriage_divorce_normal, criterion = \"waic\")\n## Warning: \n## 2 (4.0%) p_waic estimates greater than 0.4. We recommend trying loo instead.\n```\n:::\n\n\nAnd that lets us access things in deeply nested lists, like the 13th Pareto k value:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmarriage_divorce_normal$criteria$loo$diagnostics$pareto_k[13]\n## [1] 0.6065822\n```\n:::\n\n\nNeat. Now we can plot these k values and WAIC values and recreate Figure 7.10 from the book and from 1:03:00 in lecture video 7.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(psis = marriage_divorce_normal$criteria$loo$diagnostics$pareto_k,\n       p_waic = marriage_divorce_normal$criteria$waic$pointwise[, \"p_waic\"],\n       Location = pull(WaffleDivorce, Location),\n       Loc = pull(WaffleDivorce, Loc)) %>%\n  ggplot(aes(x = psis, y = p_waic)) +\n  geom_point(aes(color = Loc %in% c(\"ME\", \"ID\")), size = 2) +\n  geom_text(data = . %>% filter(Loc %in% c(\"ME\", \"ID\")), \n            aes(label = Location), hjust = 1.25) +\n  geom_vline(xintercept = 0.5, linetype = 32) +\n  scale_color_manual(values = c(\"grey40\", clrs[4]), guide = \"none\") +\n  labs(x = \"PSIS Pareto k\", y = \"WAIC penalty\")\n```\n\n::: {.cell-output-display}\n![](07-video_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n# Robust regression\n\nWe can do robust regression with `family = student()`, which has thicker tails and expects larger values out in the tails\n\n\n::: {.cell hash='07-video_cache/html/age-marriage-t_2fe05160e053c050746b567c040719e7'}\n\n```{.r .cell-code}\npriors <- c(prior(normal(0, 0.2), class = Intercept),\n            prior(normal(0, 0.5), class = b, coef = \"Marriage_z\"),\n            prior(normal(0, 0.5), class = b, coef = \"MedianAgeMarriage_z\"),\n            prior(exponential(1), class = sigma))\n\nmarriage_divorce_student <- brm(\n  bf(Divorce_z ~ Marriage_z + MedianAgeMarriage_z,\n     nu = 2),  # Tail thickness\n  data = WaffleDivorce,\n  family = student(),\n  prior = priors,\n  chains = 4, cores = 4, seed = BAYES_SEED, \n  backend = \"cmdstanr\", refresh = 0\n)\n## Start sampling\n```\n:::\n\n\nAdd penalty statistics to the model object:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmarriage_divorce_student <- add_criterion(marriage_divorce_student, criterion = c(\"loo\", \"waic\"))\n## Warning: \n## 2 (4.0%) p_waic estimates greater than 0.4. We recommend trying loo instead.\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- tibble(psis = marriage_divorce_student$criteria$loo$diagnostics$pareto_k,\n                    p_waic = marriage_divorce_student$criteria$waic$pointwise[, \"p_waic\"],\n                    Location = pull(WaffleDivorce, Location),\n                    Loc = pull(WaffleDivorce, Loc)) \nplot_data %>%\n  ggplot(aes(x = psis, y = p_waic)) +\n  geom_point(aes(color = Loc %in% c(\"ME\", \"ID\")), size = 2) +\n  geom_text(data = . %>% filter(Loc %in% c(\"ME\", \"ID\")), \n            aes(label = Location), hjust = 1.25) +\n  geom_vline(xintercept = 0.5, linetype = 32) +\n  scale_color_manual(values = c(\"grey40\", clrs[4]), guide = \"none\") +\n  labs(x = \"PSIS Pareto k\", y = \"WAIC penalty\")\n```\n\n::: {.cell-output-display}\n![](07-video_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nHey hey, Idaho and Maine have much lower PSIS k values now. There are some weird observations with really high WAIC values for some reason:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data |> \n  arrange(desc(p_waic))\n## # A tibble: 50 × 4\n##        psis p_waic Location     Loc  \n##       <dbl>  <dbl> <fct>        <fct>\n##  1  0.0790   0.709 Wyoming      WY   \n##  2 -0.00816  0.608 Utah         UT   \n##  3  0.00618  0.344 Arkansas     AR   \n##  4  0.0451   0.327 North Dakota ND   \n##  5  0.0223   0.309 Alaska       AK   \n##  6  0.0775   0.244 Maine        ME   \n##  7  0.102    0.240 Rhode Island RI   \n##  8  0.0301   0.215 Idaho        ID   \n##  9  0.181    0.212 Minnesota    MN   \n## 10  0.0640   0.211 New Jersey   NJ   \n## # … with 40 more rows\n```\n:::\n\n\nWyoming and Utah! Why? I don't know :(\n\n\n# Compare the models\n\nWe can compare the two models' LOO statistics:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloo_compare(marriage_divorce_normal, marriage_divorce_student, criterion = \"loo\")\n##                          elpd_diff se_diff\n## marriage_divorce_normal   0.0       0.0   \n## marriage_divorce_student -2.5       3.0\nloo_compare(marriage_divorce_normal, marriage_divorce_student, criterion = \"waic\")\n##                          elpd_diff se_diff\n## marriage_divorce_normal   0.0       0.0   \n## marriage_divorce_student -2.7       2.9\n```\n:::\n\n\nThe normal model has the higher ELPD score (so it's better), but the standard error is huge and makes the models indistinguishable (so it's not necessarily better)\n\nWe can also compare the posterior distributions for the effect of age on marriage. The coefficient for age in the Student-t model is more negative and more precise. Idaho was making the normal model too skeptical and too surprised; the Student-t model was less surprised by it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnormal_coefs <- marriage_divorce_normal |> \n  spread_draws(b_MedianAgeMarriage_z) |> \n  mutate(model = \"Gaussian model\")\n\nstudent_coefs <- marriage_divorce_student |> \n  spread_draws(b_MedianAgeMarriage_z) |> \n  mutate(model = \"Student-t model\")\n\nbind_rows(normal_coefs, student_coefs) |> \n  ggplot(aes(x = b_MedianAgeMarriage_z, fill = model)) +\n  stat_halfeye(slab_alpha = 0.75) +\n  scale_fill_manual(values = c(clrs[6], clrs[4]))\n```\n\n::: {.cell-output-display}\n![](07-video_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}